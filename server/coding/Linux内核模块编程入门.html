<!DOCTYPE html>
<html lang="cn">
<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

	<link rel="dns-prefetch" href="//hm.baidu.com"/>
	<link rel="dns-prefetch" href="//disqus.com"/>
	<link rel="dns-prefetch" href="//a.disquscdn.com"/>

	<meta name="Keywords" content="yinwoods,殷成涛,个人博客,郑州大学,linux,cpp"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<meta content="black" name="apple-mobile-web-app-status-bar-style" />
	<meta content="telephone=no" name="format-detection" />
	
	<meta name="author" content="yinwoods">

	<link rel="alternate" type="application/rss+xml" title="rss订阅" href="/feed.xml">
	<link rel="shortcut icon" href="/static/img/icon-16.png" sizes="16x16" />
	<link rel="apple-touch-icon-precomposed" href="/static/img/icon-16.png" sizes="16x16" />
	<link rel="apple-touch-icon-precomposed" href="/static/img/icon-24.png" sizes="24x24" />
	<link rel="apple-touch-icon-precomposed" href="/static/img/icon-32.png" sizes="32x32" />
	<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="/static/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="/static/css/prism.css">

    <title>Linux内核模块编程入门 | yinwoods</title>
  
	<link rel="stylesheet" href="/static/css/style.css">
	<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
		(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
		e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
		})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

		_st('install','csxq-8xzb6tiaQ1dQaGs','2.0.0');
	</script>
</head>


<body>
	<div id="container" class="container">
		<div id="content" class="content">
			<nav class="navbar">
	<div class="pull-left">
		<button id="btnMenu" type="button" class="btn btn-default btn-sm btn-menu">
			<i class="fa fa-bars"></i>	菜 单
		</button>
	</div>
	<ul class="pull-center">
		<li class="active"><a href="/">博客</a></li>
        <li><a href="/category/aboutme.html">关于我</a></li>
	</ul>
	<div class="pull-right">
		<button type="button" class="btn btn-default btn-sm btn-list">
			<a href="/category/books.html">
				<i class="fa fa-book fa-fw"></i>书单/影单  
			</a>
		</button>
	</div>
</nav>

			<header class="post-header">
        <div class="hd-img">
            <img src="http://7xlh6u.com1.z0.glb.clouddn.com/bg42.jpg" alt="背景图片">
        </div>

        <div class="title">
           <h1>Linux内核模块编程入门</h1>
        </div>
</header>
<button id="btnArrow" class="btn-arrow" data-info="点击显示文章"><i class="icon icon-arrow-down">&#xe619;</i></button>
<div class="post-title">
	<h1>Linux内核模块编程入门</h1>
	
    <p>作者: <a target="_blank" href="http://blog.yinwoods.com/"><strong>yinwoods</strong></a>&nbsp;&nbsp;&nbsp;
        分类: <a target="_blank" href="http://blog.yinwoods.com/coding.html"><strong>coding</strong></a>&nbsp;&nbsp;&nbsp;
        日期: <strong>2016年01月14日</strong>&nbsp;&nbsp;&nbsp;
         <ul class="tags post-tags">
            
            
            
                
            
                
            
            
            
                
            
                
            
            
            
                
            
                
            
            
            
                
            
                
            
            
            
                
            
                
            
            
            
                
                    <li><a href="/tags/linux/index.html">linux<span>3</span></a></li>
                
            
                
            
            
            
                
            
                
            
            
            
                
            
                
            
            
            
                
            
                
                    <li><a href="/tags/cpp/index.html">cpp<span>8</span></a></li>
                
            
            
            
                
            
                
            
            
            
                
            
                
            
            
            
                
            
                
            
            
            
                
            
                
            
            
        </ul>
    </p>           
</div>
    

    <article class="post-content">
        <hr class="post-end-left"><p class="post-end">开始</p><hr class="post-end-right"/>
        <div>
            <p>首先我们要明确linux下内核编程与平时我们在linux下写的C程序之间的区别，在这里我们把在linux下写一般C程序的过程称之为用户层编程，与之相对的就是我们要学习的内核编程。</p>

<p>首先介绍linux内核，<strong>内核</strong>指的是一个提供硬件抽象层、磁盘、文件系统控制及多任务等功能的系统软件。我们可以把内核理解为操作系统的核心部分（<strong>注意：内核不等于操作系统</strong>）。而linux内核就是linux操作系统的内核。</p>

<p>内核由负责不同功能的内核模块组成，内核模块可以被单独编译，但是不能单独运行，它必须要链接到内核作为内核的一部分在内核空间中运行。内核之所以采用这种结构方式是因为这体现了模块化的思想，在保证内核不会太大的同时，又可以做到模块一旦被加载就和内核中的其他部分一样使用。</p>

<p>用户层编程和内核模块编程的区别：</p>

<p><img src="http://7xlnl2.com1.z0.glb.clouddn.com/post42-difference.jpg" alt="用户层编程与内核模块编程区别" /></p>

<p>下面编写一个内核模块中的hello world程序:</p>

<div>
  <pre><code class="cpp">//filename: hello.c

#include &lt;linux/init.h&gt;

#include &lt;linux/module.h&gt;

#include &lt;linux/kernel.h&gt;

//这里的三个头文件是编写内核模块程序所必须的

MODULE_LICENSE(&quot;Dual BSD/GPL&quot;);

/*可选

MODULE_AUTHOR(&quot;yinwoods&quot;);

MODULE_DESCRIPTION(&quot;This is a simple example!\n&quot;);

MODULE_ALIAS(&quot;A simplest example&quot;);

*/

static int hello_init(void) {
    printk(KERN_ALERT &quot;hello, I am yinwoods&quot;);
    //printk是内核态信息打印函数，功能上与printf类似。不同的是printk具有消息打印机别，这里的KERN_ALERT即为一个消息级别。
    return 0;
}

static void hello_exit(void) {
    printk(KERN_ALERT &quot;good bye, kernel\n&quot;);
}

module_init(hello_init);
module_exit(hello_exit);</code></pre>
</div>

<h3 id="moduleinitmoduleexit">module_init()函数和module_exit()函数</h3>

<p><code>module_init(hello_init)</code>是指模块程序从<code>hello_init</code>开始执行，函数参数就是注册函数的函数名。</p>

<p>同理，<code>module_exit(hello_exit)</code>是指模块程序从<code>hello_exit</code>离开，函数参数就是卸载函数的函数名。</p>

<p>这里可以类比C++类中的构造函数与析构函数；也就是说我们一般在<code>module_init()</code>中动态申请内存、中断等资源；而在模块卸载函数<code>module_exit()</code>中回收这些资源。</p>

<p>程序写好了，那么怎么编译运行呢？</p>

<h3 id="section">内核编写程序的编译运行</h3>

<p>在linux下对内核程序进行编译运行与普通程序是不同的，不是通过g++的命令实现,而是需要我们编写makefile脚本并使用make命令来实现多文件的编译。</p>

<p>makefile是一种脚本，这种脚本主要是用于多文件的编译。它定义了一系列的规则来指定哪些文件需要先编译，哪些文件需要后编译，哪些文件需要重新编译等等。</p>

<p>make是一个解释makefile中指令的命令工具，可以维护具有相互依赖性的源文件，当某些文件发生改变时，它能自动识别出，并只对改动后的文件进行编译。</p>

<h3 id="makefile">简单介绍一下如何编写makefile：</h3>

<p>makefile的规则大体上就是以下格式：</p>

<div>
  <pre><code class="cpp">target:dependency-file
    command</code></pre>
</div>

<p>target是一个目标文件，可以是Object File（linux下的.o文件），也可以是最终的执行文件。
而dependency-file是生成相应target所需要依赖的文件或者其它的target。
command就是最终由make执行的命令。</p>

<p>也就是说我们告诉了make程序需要生成的文件target和它所依赖的dependency-file文件还有执行命令command，那么make程序只需要按照这种方式解析makefile即可。</p>

<h3 id="section-1">内核程序的编译运行</h3>

<p>1、编写好makefile文件</p>

<p>2、使用make进行编译</p>

<p>3、编译后使用sudo insmod *.ko 加载模块</p>

<p>4、使用dmesg查看运行结果</p>

<p>5、使用rmmod tiger卸载模块</p>

<p>6、使用make clean删除中间生成的文件</p>

<p>在这里贴出示例程序对应的makefile文件：</p>

<div>
  <pre><code class="bash">KERNEL_DIR = /usr/src/linux-headers-$(shell uname -r)/
#KERNAL_DIR表示内核源代码的位置。在这里是链接到包含着正在使用内核对应源代码的目录树位置。
PWD := $(shell pwd)
#PWD指示了当前工作目录并且是我们自己内核模块的源代码位置。

obj-m := hello.o

#需要编译连接多个文件时，只需要在添加。再添加相应的语句即可，如下：
#obj-m += device1.o
#obj-m += device2.o

all:
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) modules
#这里是指在包含源代码位置的地方进行make，然后编译$(PWD)目录下的modules。这里允许我们使用所有定义在内核源代码树下的所有规则来编译我们的内核模块。

clean:
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) clean
	$(RM) Module.markers modules.order</code></pre>
</div>

<p>按照上述的编译运行步骤，make, insmod hello.ko, dmesg即可看到</p>

<p><code>
hello, I am yinwoods
good bye, kernel
</code></p>

<p>最后通过rmmod hello 卸载该模块。</p>

<p>因为导师布置的毕设题目是platform虚拟总线下的进程调度，所以这段时间要好好补一补linux内核设备驱动方面知识了。</p>

<p>下一步是实现platform下简单的线程通信。加油！</p>

        </div>
        <hr class="post-end-left"><p class="post-end">结束</p><hr class="post-end-right"/>
        <div class="post-footer">
            
            <p class="post-footer-previous">上一篇 ： <a class="entry-more" href="/coding/windows%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6.html">windows进程通信方式&消息处理机制</a></p>
            
            
            <p class="post-footer-next">下一篇 ： <a class="entry-more" href="/coding/%E5%9F%BA%E7%A1%80%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93.html">基础排序算法总结</a></p>
            
        </div>
    <!-- JiaThis Button BEGIN -->
    <div class="jiathis_style">
        <span style="font-family:sans-serif; color:#009966">分享到：</span>
        <a class="jiathis_button_weixin share_button" href="#"></a>
        <a class="jiathis_button_tsina share_button" href="#"></a>
        <a class="jiathis_button_qzone share_button" href="#"></a>
        <a class="jiathis_button_evernote share_button" href="#"></a>
        <a class="jiathis_button_ydnote share_button" href="#"></a>
        <a class="jiathis_button_pocket share_button" href="#"></a>
        <a class="jiathis_button_douban share_button" href="#"></a>
        <a class="jiathis_button_renren share_button" href="#"></a>
        <a class="jiathis_button_fb share_button" href="#"></a>
        <a class="jiathis_button_linkedin share_button" href="#"></a>
        <a class="jiathis_button_googleplus share_button" href="#"></a>
        <a class="jiathis_button_tumblr share_button" href="#"></a>
        <a class="jiathis_counter_style"></a>
    </div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/totop.js" charset="utf-8"></script>
<!-- JiaThis Button END -->
<script type="text/javascript" src="/static/js/prism.js" charset="utf-8"></script>
</article>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'yinwoods'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    



		</div>

				<nav id="menu" class="menu">
			<ul>
				<li class="logo"><a href="/category/aboutme.html"><img  class="img-circle" height="100px" width="100px" src="/static/img/about/me.jpg"></a></li>

				<li><a href="/category/index.html"><i class="fa fa-home fa-fw"></i>首页</a></li>
				
				<li><a href="/category/coding.html"><i class="fa fa-road fa-fw"></i>编程之路</a></li>

				<li><a href="/category/myshare.html"><i class="fa fa-share-alt fa-fw"></i>我的分享</a></li>
				
				<li><a href="/category/diary.html"><i class="fa fa-calculator fa-fw"></i>生活日志</a></li>
				
				<li><a href="/category/book-movie-list/booklist.html"><i class="fa fa-book fa-fw"></i>书单/影单</a></li>

				<li><a href="/category/aboutme.html"><i class="fa fa-male fa-fw"></i>关于博主</a></li>

				<li><a href="/category/friend.html"><i class="fa fa-send fa-fw"></i>我的朋友</a></li>

				<li><img class="img-rounded" height="100px" width="100%" src="/static/img/about/footer.png"></li>

			</ul>
			<button id="btnClose" class="btn-close"></button>

			<div id="SVGMenu" class="svg-menu" 
                data-menu-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z" 
                data-menu-close="M-6,0h101c0,0-90,153.603-90,396.167C2.167,627.579,100,800,100,800H-1V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
				<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
					<path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
				</svg>
			</div>

		</nav>


		<footer class="footer">
	<div class="row">
		<div class="pull-left">
			<a class="avatar" href="/" title="yinwoods">yinwoods</a>
			<p class="copyright">2015 ALL RIGHTS RESERVED</p>
		</div>
		
		<div class="pull-center">
			<ul class="list-inline">
				<li>
					<a href="http://weibo.com/yinwoods">
						<img src="/static/img/footer/weibo.png">
					</a>
				</li>
				<li>
					<a href="https://github.com/yinwoods">
						<img src="/static/img/footer/github.png">
					</a>
				</li>
				<li>
					<a href="/feed.xml">
						<img src="/static/img/footer/rss.png">
					</a>
				</li>
			</ul>
			<br/>
			<h4>Powered by <a target="_blank" href="https://github.com/yinwoods">github</a> && <a target="_blank" href="http://jekyllrb.com/">jekyll</a></h4>
		</div>

	</div>
</footer>
		<div id="totop">
			<a title="返回顶部">返回顶部</a>
		</div>
	</div>

	<script type="text/javascript" src="/static/js/classie.js"></script>

	<script type="text/javascript" src="/static/js/snap.svg-min.js"></script>
	<script type="text/javascript" src="/static/js/menuTriggle.js"></script>
	<script type="text/javascript" src="/static/js/SVGButton.js"></script>

	<script type="text/javascript" src="/static/js/postTriggle.js"></script>

	
	<script type="text/javascript" src="/static/js/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="/static/js/totop.js"></script>
	<script type="text/javascript">
		var content = document.querySelector('.content'),
			footer = document.querySelector('.footer'),
			footT  = footer.offsetTop,
			footH  = footer.offsetHeight,
			winH   = window.innerHeight,
			post   = document.querySelectorAll('p');

		if (footT - footH + 100 < winH) {
			content.style.height = '100%';
		};

		for (var i = 0; i < post.length; i++) {
			if (post.item(i).querySelector('img')) {
				post.item(i).style.textIndent = 0;
			};
		};

	</script>
</body>
</html>
