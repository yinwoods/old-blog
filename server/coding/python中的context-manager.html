<!DOCTYPE html>
<html lang="cn">
<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

	<link rel="dns-prefetch" href="//hm.baidu.com"/>
	<link rel="dns-prefetch" href="//disqus.com"/>
	<link rel="dns-prefetch" href="//a.disquscdn.com"/>

	<meta name="Keywords" content="yinwoods,殷成涛,个人博客,郑州大学,python"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<meta content="black" name="apple-mobile-web-app-status-bar-style" />
	<meta content="telephone=no" name="format-detection" />
	
	<meta name="author" content="yinwoods">

	<link rel="alternate" type="application/rss+xml" title="rss订阅" href="/feed.xml">
	<link rel="shortcut icon" href="/static/img/icon-16.png" sizes="16x16" />
	<link rel="apple-touch-icon-precomposed" href="/static/img/icon-16.png" sizes="16x16" />
	<link rel="apple-touch-icon-precomposed" href="/static/img/icon-24.png" sizes="24x24" />
	<link rel="apple-touch-icon-precomposed" href="/static/img/icon-32.png" sizes="32x32" />
	<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="/static/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="/static/css/prism.css">

    <title>python中的context manager | yinwoods</title>
  
	<link rel="stylesheet" href="/static/css/style.css">
	<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
	<script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
		(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
		e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
		})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

		_st('install','csxq-8xzb6tiaQ1dQaGs','2.0.0');
	</script>
</head>


<body>
	<div id="container" class="container">
		<div id="content" class="content">
			<nav class="navbar">
	<div class="pull-left">
		<button id="btnMenu" type="button" class="btn btn-default btn-sm btn-menu">
			<i class="fa fa-bars"></i>	菜 单
		</button>
	</div>
	<ul class="pull-center">
		<li class="active"><a href="/">博客</a></li>
        <li><a href="/category/aboutme.html">关于我</a></li>
	</ul>
	<div class="pull-right">
		<button type="button" class="btn btn-default btn-sm btn-list">
			<a href="/category/books.html">
				<i class="fa fa-book fa-fw"></i>书单/影单  
			</a>
		</button>
	</div>
</nav>

			<header class="post-header">
        <div class="hd-img">
            <img src="http://7xlh6u.com1.z0.glb.clouddn.com/bg53.jpg" alt="背景图片">
        </div>

        <div class="title">
           <h1>python中的context manager</h1>
        </div>
</header>
<button id="btnArrow" class="btn-arrow" data-info="点击显示文章"><i class="icon icon-arrow-down">&#xe619;</i></button>
<div class="post-title">
	<h1>python中的context manager</h1>
	
    <p>作者: <a target="_blank" href="http://blog.yinwoods.com/"><strong>yinwoods</strong></a>&nbsp;&nbsp;&nbsp;
        分类: <a target="_blank" href="http://blog.yinwoods.com/coding.html"><strong>coding</strong></a>&nbsp;&nbsp;&nbsp;
        日期: <strong>2016年08月08日</strong>&nbsp;&nbsp;&nbsp;
         <ul class="tags post-tags">
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    <li><a href="/tags/python/index.html">python<span>15</span></a></li>
                
            
            
            
                
            
            
            
                
            
            
        </ul>
    </p>           
</div>
    

    <article class="post-content">
        <hr class="post-end-left"><p class="post-end">开始</p><hr class="post-end-right"/>
        <div>
            <p>最近在读python进阶类书籍《Intermediate Python》，看到后面有一章讲到<code>context manager</code>，讲的很浅，我也没看懂。于是自己抽时间搜集了网上的一些资料，整理如下：</p>

<p>python中的<code>context manager</code>也叫做上下文管理器，主要功能是确保代码块始终能够得到正确的‘善后’处理。有点像java中的<code>try 	... catch 	... finally 	...</code></p>

<p>对于打开文件读写，我们都知道下面的实现方式更好：</p>

<p><code>python
with open('file') as f:
    for line in f:
    	print(line)
</code></p>

<p>但这种方式为什么更好呢？原因在于使用<code>with</code>可以执行<code>context manager</code>的相应函数，确保被打开的文件始终能够被关闭。如果我们自己手动<code>open()</code>、<code>close()</code>则可能会因为中间代码产生的异常导致<code>close()</code>无法执行。因此使用<code>with</code>可以让代码既简洁又有效。</p>

<p>下面接着说一说<code>context manager</code>的功能与用法。</p>

<h3 id="section">管理资源</h3>

<p><code>context manager</code>最常被用于管理资源，事实上，这也是很多时候我们使用它的原因。</p>

<p>当我们打开一个文件时，程序会占有对应的资源（文件描述符），而资源的管理则由操作系统来完成，也就是说同一时间能够打开的文件或进程是有限的。</p>

<p>例如，运行下面这份代码：</p>

<p><code>python
files = []
for x in range(100000):
    files.append(open('foo.txt', 'w'))
</code></p>

<p>在mac os或linux上运行这份代码很有可能会产生OSError而导致中断，而在windows上运行程序则可能导致系统直接卡死。</p>

<p>那么问题的原因是什么呢？</p>

<p>答：是<em>内存泄露！</em> 这里的泄露原因是指打开文件后但未关闭。</p>

<p>为了避免对文件操作时产生上述的错误，有两种解决方法：</p>

<blockquote>
  <p>1、避免同时打开超过操作系统上限个数个文件；</p>
</blockquote>

<blockquote>
  <p>2、每次打开文件后关闭文件；</p>
</blockquote>

<p>毫无疑问，这里2的操作更好，因为能够更好地实现高层抽象并解决内存泄露问题。</p>

<p>先说1：在unix上<code>ulimit -n</code>可以查看同时打开文件描述符上限，在写代码时确保同时打开的文件数不超过上限值即可。但是这里并没有解决根本问题：内存泄露！</p>

<p>再说2：我们当然可以为上面的代码添加close()函数，可是如果打开文件或者对文件内容处理时产生异常，那么后面的<code>close()</code>就无法被执行，从而导致内存泄露。</p>

<p><code>context manager</code>正是用于处理这种情况的一个接口：</p>

<p><code>python
with something_that_returns_a_context_manager() as my_resource:
    do_something(my_resource)
    ...
    print('done using my_resource')
</code></p>

<p>使用<code>with</code>，我们可以操作任何一个返回上下文管理器的函数（例如内置函数<code>open()</code>）；<code>with</code>能够保证当相应代码块内的代码执行完毕时，始终调用一个包含清理资源的‘善后’函数。这个‘善后’函数就定义在<code>context manager</code>中。</p>

<p>实现一个最简单的context manager只要求包含<code>__enter__()</code>函数以及<code>__exit__()</code>。</p>

<blockquote>
  <p><code>__enter__()</code>执行操作并返回被管理的资源；</p>
</blockquote>

<blockquote>
  <p><code>__exit__()</code>则清理资源，无返回。</p>
</blockquote>

<p>例如我们通过以下代码创建一个自己的<code>context manager</code>：</p>

<p>```python
class File():</p>

<pre><code>def __init__(self, filename, mode):
    self.filename = filename
    self.mode = mode
    
def __enter__(self):
    self.open_file = open(self.filename, self.mode)
    return self.open_file
    
def __exit__(self):
    self.open_file.close()
</code></pre>

<p>files = []
for _ in range(100000):
    with File(‘foo.txt’, ‘w’) as f:
        files.append(f.write(‘foo’))
```</p>

<p>这里<code>__enter__()</code>打开文件，并返回；<code>__exit__()</code>则关闭文件。</p>

<h3 id="section-1">其他有用的资源管理器</h3>

<p>很多库中也包含资源管理器，例如<code>zipfile.ZipFile</code>、<code>subprocess.Popen</code>、<code>tarfile.TarFile</code>、<code>telnet.Telnet</code>、<code>pathlib.Path</code>等。其实，在使用完资源之后调用<code>close()</code>方法的都是<code>context manager</code>。</p>

<h3 id="contextlib">关于<code>contextlib</code></h3>

<p><code>contextlib</code>模块包含了许多创建、使用<code>context manager</code>的工具。</p>

<p>例如使用<code>@contextmanager</code>装饰器来创建一个<code>context manager</code>。具体的创建方法是使用<code>@contextmanager</code>来装饰只包含一个<code>yield</code>语句的<code>generator</code>函数。在<code>yield</code>之前的部分都被视为<code>__enter__()</code>函数内容，而之后的部分则是<code>__exit__()</code>函数内容。下面让我们用这种方法来重写<code>File()</code>:</p>

<p>```python
from contextlib import contextmanager</p>

<p>@contextmanager
def open_file(path, mode):
    the_file = open(path, mode)
    yield the_file
    the_file.close()</p>

<p>files = []</p>

<p>for x in range(100000):
    with open_file(‘foo.txt’, ‘w’) as f:
        files.append(f)</p>

<p>```</p>

<p>对比后可以发现使用这种方法的代码更加简洁。</p>

<p>另外有一个很简单的例子可以帮助你理解<code>@contextmanager</code></p>

<p>```python
from contextlib import contextmanager</p>

<p>@contextmanager
def tag(name):
    print(“&lt;%s&gt;” % name)
    yield
    print(“&lt;/%s&gt;” % name)</p>

<p>with tag(“h1”):
    print(“hello, world!”)
```</p>

<p>输出：<code>&lt;h1&gt;hello, world!&lt;/h1&gt;</code></p>

<p>另外也可以通过<code>contextlib.ContextDecorator</code>来实现自己的<code>context manager</code>装饰器。例如接着使用上面的例子来说明：</p>

<p>```python
from contextlib import ContextDecorator</p>

<p>class makeparagraph(ContextDecorator):
    def <strong>enter</strong>(self):
        print(‘&lt;p&gt;’)
        return self</p>

<pre><code>def __exit__(self, *exc):
    print('&lt;/p&gt;')
    return False
</code></pre>

<p>@makeparagraph
def emit_html():
    print(‘Here is some non-HTML’)
```</p>

<p>执行<code>emit_html()</code>
会输出<code>&lt;p&gt;Here is some non-HTML&lt;/p&gt;</code></p>

<h3 id="section-2">参考文章：</h3>

<blockquote>
  <ul>
    <li><a href="https://www.python.org/dev/peps/pep-0343/">PEP 34</a></li>
  </ul>
</blockquote>

<blockquote>
  <ul>
    <li><a href="https://jeffknupp.com/blog/2016/03/07/python-with-context-managers/">Python with Context Managers</a></li>
  </ul>
</blockquote>

        </div>
        <hr class="post-end-left"><p class="post-end">结束</p><hr class="post-end-right"/>
        <div class="post-footer">
            
            <p class="post-footer-previous">上一篇 ： <a class="entry-more" href="/myshare/python%E7%88%AC%E8%99%ABrequests%E7%99%BB%E5%BD%95%E8%A7%A3%E5%86%B3422%E9%94%99%E8%AF%AF.html">python爬虫requests登录解决422错误</a></p>
            
            
        </div>
    <!-- JiaThis Button BEGIN -->
    <div class="jiathis_style">
        <span style="font-family:sans-serif; color:#009966">分享到：</span>
        <a class="jiathis_button_weixin share_button" href="#"></a>
        <a class="jiathis_button_tsina share_button" href="#"></a>
        <a class="jiathis_button_qzone share_button" href="#"></a>
        <a class="jiathis_button_evernote share_button" href="#"></a>
        <a class="jiathis_button_ydnote share_button" href="#"></a>
        <a class="jiathis_button_pocket share_button" href="#"></a>
        <a class="jiathis_button_douban share_button" href="#"></a>
        <a class="jiathis_button_renren share_button" href="#"></a>
        <a class="jiathis_button_fb share_button" href="#"></a>
        <a class="jiathis_button_linkedin share_button" href="#"></a>
        <a class="jiathis_button_googleplus share_button" href="#"></a>
        <a class="jiathis_button_tumblr share_button" href="#"></a>
        <a class="jiathis_counter_style"></a>
    </div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/totop.js" charset="utf-8"></script>
<!-- JiaThis Button END -->
<script type="text/javascript" src="/static/js/prism.js" charset="utf-8"></script>
</article>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'yinwoods'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    



		</div>

				<nav id="menu" class="menu">
			<ul>
				<li class="logo"><a href="/category/aboutme.html"><img  class="img-circle" height="100px" width="100px" src="/static/img/about/me.jpg"></a></li>

				<li><a href="/category/index.html"><i class="fa fa-home fa-fw"></i>首页</a></li>
				
				<li><a href="/category/coding.html"><i class="fa fa-road fa-fw"></i>编程之路</a></li>

				<li><a href="/category/myshare.html"><i class="fa fa-share-alt fa-fw"></i>我的分享</a></li>
				
				<li><a href="/category/diary.html"><i class="fa fa-calculator fa-fw"></i>生活日志</a></li>
				
				<li><a href="/category/book-movie-list/booklist.html"><i class="fa fa-book fa-fw"></i>书单/影单</a></li>

				<li><a href="/category/aboutme.html"><i class="fa fa-male fa-fw"></i>关于博主</a></li>

				<li><a href="/category/friend.html"><i class="fa fa-send fa-fw"></i>我的朋友</a></li>

				<li><img class="img-rounded" height="100px" width="100%" src="/static/img/about/footer.png"></li>

			</ul>
			<button id="btnClose" class="btn-close"></button>

			<div id="SVGMenu" class="svg-menu" 
                data-menu-open="M-7.312,0H15c0,0,66,113.339,66,399.5C81,664.006,15,800,15,800H-7.312V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z" 
                data-menu-close="M-6,0h101c0,0-90,153.603-90,396.167C2.167,627.579,100,800,100,800H-1V0z;M-7.312,0H100c0,0,0,113.839,0,400c0,264.506,0,400,0,400H-7.312V0z">
				<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 800" preserveAspectRatio="none">
					<path d="M-7.312,0H0c0,0,0,113.839,0,400c0,264.506,0,400,0,400h-7.312V0z"/>
				</svg>
			</div>

		</nav>


		<footer class="footer">
	<div class="row">
		<div class="pull-left">
			<a class="avatar" href="/" title="yinwoods">yinwoods</a>
			<p class="copyright">2015 ALL RIGHTS RESERVED</p>
		</div>
		
		<div class="pull-center">
			<ul class="list-inline">
				<li>
					<a href="http://weibo.com/yinwoods">
						<img src="/static/img/footer/weibo.png">
					</a>
				</li>
				<li>
					<a href="https://github.com/yinwoods">
						<img src="/static/img/footer/github.png">
					</a>
				</li>
				<li>
					<a href="/feed.xml">
						<img src="/static/img/footer/rss.png">
					</a>
				</li>
			</ul>
			<br/>
			<h4>Powered by <a target="_blank" href="https://github.com/yinwoods">github</a> && <a target="_blank" href="http://jekyllrb.com/">jekyll</a></h4>
		</div>

	</div>
</footer>
		<div id="totop">
			<a title="返回顶部">返回顶部</a>
		</div>
	</div>

	<script type="text/javascript" src="/static/js/classie.js"></script>

	<script type="text/javascript" src="/static/js/snap.svg-min.js"></script>
	<script type="text/javascript" src="/static/js/menuTriggle.js"></script>
	<script type="text/javascript" src="/static/js/SVGButton.js"></script>

	<script type="text/javascript" src="/static/js/postTriggle.js"></script>

	
	<script type="text/javascript" src="/static/js/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="/static/js/totop.js"></script>
	<script type="text/javascript">
		var content = document.querySelector('.content'),
			footer = document.querySelector('.footer'),
			footT  = footer.offsetTop,
			footH  = footer.offsetHeight,
			winH   = window.innerHeight,
			post   = document.querySelectorAll('p');

		if (footT - footH + 100 < winH) {
			content.style.height = '100%';
		};

		for (var i = 0; i < post.length; i++) {
			if (post.item(i).querySelector('img')) {
				post.item(i).style.textIndent = 0;
			};
		};

	</script>
</body>
</html>
